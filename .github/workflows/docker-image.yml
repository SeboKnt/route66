name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  build_and_cache: |-
    build_and_cache() {
      platform=$1
      cache_path=$2
      tag_suffix=$3
      cache_name=$4

      if ! docker buildx build \
        --platform $platform \
        --cache-from type=local,src=$cache_path \
        --cache-to type=local,dest=$cache_path \
        --tag ${GITHUB_REPOSITORY,,}:$tag_suffix \
        --file Dockerfile . ;
      then
        echo "::error::Docker-Build Error. $cache_name Cache will be deleted now!"
        rm -rf $cache_path
      fi
    }
  
  echo: |-
    echo() {
      echo $1
    }

jobs:

  build:

    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: update cache on every commit
      uses: actions/cache@v3
      with:
        path: /home/runner/tmp
        key: docker-${{ github.run_id }}
        restore-keys: |
          docker-
    
    - name: Env prep
      run: | 
        docker buildx create --use
        docker buildx inspect --bootstrap

    - name: Docker Build
      run: |
        ${{ env.echo }} Helloooo